# 需求文档

## 简介

本功能旨在增强 InkFlow 的长篇小说创作能力，通过引入分卷管理和深度上下文细纲生成，解决当前系统在处理超长篇作品时的结构扁平化和细纲断层问题。

## 术语表

- **系统 (System)**: InkFlow 小说创作应用
- **分卷 (Volume)**: 小说的结构层级，位于书和章节之间，通常包含 100-150 章
- **细纲 (Beats)**: 章节内的详细剧情步骤，指导 AI 按顺序生成内容
- **上下文窗口 (Context Window)**: 生成细纲时参考的前文信息范围
- **钩子 (Hook)**: 章节结尾留下的悬念或未解决的情节点
- **用户 (User)**: 使用 InkFlow 创作小说的作者
- **AI 生成器 (AI Generator)**: 调用 LLM API 生成内容的服务模块

## 需求

### 需求 1：分卷管理

**用户故事**: 作为一名网文作者，我希望能够将章节组织成卷，以便更好地规划长篇小说的宏观节奏和剧情弧。

#### 验收标准

1. WHEN 用户创建新分卷 THEN 系统 SHALL 生成包含唯一 ID、标题、摘要、顺序号的分卷实体
2. WHEN 用户将章节拖入分卷 THEN 系统 SHALL 更新章节的 volumeId 字段并保持章节在卷内的顺序
3. WHEN 用户查看大纲页面 THEN 系统 SHALL 按分卷分组显示章节，并显示每卷的统计信息（章节数、总字数）
4. WHEN 用户删除分卷 THEN 系统 SHALL 将该卷内的章节的 volumeId 设为 null，但保留章节本身
5. WHEN 用户编辑分卷信息 THEN 系统 SHALL 实时更新分卷的标题、摘要和核心冲突字段

### 需求 2：分卷上下文注入

**用户故事**: 作为一名网文作者，我希望 AI 在生成章节时能够理解当前所处的分卷背景，以便生成符合宏观节奏的内容。

#### 验收标准

1. WHEN AI 生成章节内容且章节属于某个分卷 THEN 系统 SHALL 在 prompt 中注入该卷的摘要和核心冲突
2. WHEN AI 生成章节内容且章节属于某个分卷 THEN 系统 SHALL 计算并注入本卷进度百分比（如：第 3/10 章）
3. WHEN 用户完成一卷的最后一章 THEN 系统 SHALL 提示用户可选择生成"分卷总结"
4. WHEN 用户生成分卷总结 THEN 系统 SHALL 基于该卷所有章节摘要生成 500-1000 字的回顾文本
5. WHEN AI 生成新卷的第一章 THEN 系统 SHALL 在 prompt 中包含上一卷的总结（如果存在）

### 需求 3：深度上下文细纲生成

**用户故事**: 作为一名网文作者，我希望生成的细纲能够与前文自然衔接，避免出现剧情断层和重复描写。

#### 验收标准

1. WHEN 用户为非首章生成细纲 THEN 系统 SHALL 读取上一章的最后 500 字符作为衔接上下文
2. WHEN 用户为非首章生成细纲 THEN 系统 SHALL 检测上一章是否有未解决的钩子（通过 AI 分析或用户标记）
3. WHEN 系统检测到上一章有钩子 THEN 系统 SHALL 在生成细纲的 prompt 中明确要求回应这些钩子
4. WHEN 用户生成细纲 THEN 系统 SHALL 在 prompt 中包含当前章节的祖先章节摘要（用于分支剧情）
5. WHEN 细纲生成完成 THEN 系统 SHALL 返回 5-8 个具体的剧情步骤字符串数组

### 需求 4：分卷可视化

**用户故事**: 作为一名网文作者，我希望在大纲页面直观地看到分卷结构，以便快速定位和调整剧情安排。

#### 验收标准

1. WHEN 用户打开大纲页面且存在分卷 THEN 系统 SHALL 以可折叠的卡片形式显示每个分卷
2. WHEN 用户点击分卷卡片 THEN 系统 SHALL 展开或折叠该卷内的章节列表
3. WHEN 系统显示分卷卡片 THEN 系统 SHALL 显示卷标题、章节数量、总字数和进度条
4. WHEN 用户拖拽章节到分卷卡片 THEN 系统 SHALL 提供视觉反馈（高亮边框）并在释放时完成移动
5. WHEN 用户在分卷卡片上悬停 THEN 系统 SHALL 显示快捷操作按钮（编辑、删除、生成总结）

### 需求 5：数据持久化

**用户故事**: 作为一名网文作者，我希望分卷结构和增强的细纲数据能够可靠保存，以便随时恢复工作进度。

#### 验收标准

1. WHEN 用户创建或修改分卷 THEN 系统 SHALL 在 2 秒内自动保存到 IndexedDB
2. WHEN 用户重新加载项目 THEN 系统 SHALL 完整恢复所有分卷数据和章节关联
3. WHEN 系统保存项目 THEN 系统 SHALL 在 NovelState 中包含 volumes 数组
4. WHEN 章节包含钩子标记 THEN 系统 SHALL 将钩子数据保存在 Chapter 的 hooks 字段中
5. WHEN 分卷包含总结 THEN 系统 SHALL 将总结文本保存在 Volume 的 summary 字段中

### 需求 6：向后兼容

**用户故事**: 作为现有 InkFlow 用户，我希望升级后能够无缝访问我的旧项目，不丢失任何数据。

#### 验收标准

1. WHEN 系统加载没有 volumes 字段的旧项目 THEN 系统 SHALL 将 volumes 初始化为空数组
2. WHEN 系统加载没有 volumeId 的旧章节 THEN 系统 SHALL 将 volumeId 保持为 null 或 undefined
3. WHEN 系统加载没有 hooks 字段的旧章节 THEN 系统 SHALL 将 hooks 初始化为空数组
4. WHEN 用户在旧项目中创建新章节 THEN 系统 SHALL 使用新的数据结构但不强制分配到分卷
5. WHEN 数据库版本升级 THEN 系统 SHALL 执行迁移脚本而不清空现有数据

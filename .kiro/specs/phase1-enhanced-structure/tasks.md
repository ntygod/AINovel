# 实施计划

## 任务列表

- [x] 1. 数据模型和类型定义





  - 在 `types.ts` 中添加 Volume 接口
  - 扩展 Chapter 接口添加 volumeId 和 hooks 字段
  - 扩展 NovelState 接口添加 volumes 数组
  - _需求: 1.1, 1.2, 5.3, 5.4_

- [x] 2. 数据库服务扩展





  - 在 `services/db.ts` 中实现向后兼容逻辑
  - 添加加载旧项目时的字段初始化
  - 确保保存时包含新字段
  - _需求: 5.1, 5.2, 6.1, 6.2, 6.3, 6.4_

- [x] 3. 分卷管理核心逻辑





  - 实现 createVolume() 函数
  - 实现 updateVolume() 函数
  - 实现 deleteVolume() 函数（章节 volumeId 置空）
  - 实现 moveChapterToVolume() 函数
  - _需求: 1.1, 1.2, 1.4, 1.5_

- [x] 4. 分卷统计和工具函数





  - 实现 getVolumeStats() 计算章节数和总字数
  - 实现 getVolumeProgress() 计算章节在卷中的进度
  - 实现 isLastChapterComplete() 检查是否可生成总结
  - _需求: 1.3, 2.2, 2.3_

- [x] 5. 检查点 - 数据层完成





  - 确保所有测试通过，询问用户是否有问题

- [x] 6. 深度上下文工具函数





  - 实现 findPreviousChapter() 查找上一章（支持线性和分支）
  - 实现 extractLastContent() 提取章节结尾内容
  - 扩展 getChapterAncestors() 确保正确处理分支
  - _需求: 3.1, 3.4_

- [x] 7. 增强 generateChapterBeats 函数





  - 修改函数签名添加 volumes 参数
  - 实现上一章结尾提取逻辑
  - 实现钩子读取和注入逻辑
  - 实现祖先摘要构建逻辑
  - 实现分卷上下文注入逻辑
  - 构建增强的 prompt 模板
  - _需求: 2.1, 2.2, 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 8. 分卷总结生成功能





  - 实现 generateVolumeSummary() 函数
  - 基于卷内所有章节摘要生成 500-1000 字总结
  - 保存总结到 Volume.volumeSummary 字段
  - _需求: 2.3, 2.4_

- [x] 9. 检查点 - 核心逻辑完成





  - 确保所有测试通过，询问用户是否有问题

- [x] 10. VolumeCard 组件实现


  - 创建 `components/VolumeCard.tsx`
  - 实现分卷卡片 UI（标题、统计、进度条）
  - 实现折叠/展开功能
  - 实现快捷操作按钮（编辑、删除、生成总结）
  - 添加拖放支持（接收章节）
  - _需求: 1.3, 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 11. 增强 OutlineBuilder 组件


  - 添加 volumes 状态管理
  - 实现"新建分卷"功能
  - 实现分卷编辑对话框
  - 实现分卷删除确认
  - 实现章节拖拽到分卷
  - 按分卷分组显示章节
  - 显示未分配章节区域
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 4.1, 4.4_

- [x] 12. 增强 Editor 组件细纲面板


  - 显示上一章信息（标题、结尾内容）
  - 显示上一章的钩子列表
  - 实现钩子编辑器（添加、编辑、删除）
  - 更新 handleGenerateBeats 调用传入 volumes
  - _需求: 3.2, 3.3_


- [x] 13. App.tsx 状态管理更新

  - 在 NovelState 中初始化 volumes 为空数组
  - 实现 updateVolumes() 函数
  - 传递 volumes 到 OutlineBuilder 和 Editor
  - 确保自动保存包含 volumes
  - _需求: 5.1, 5.2, 5.3_

- [x] 14. 检查点 - UI 完成



  - 确保所有测试通过，询问用户是否有问题

- [x] 15. 样式和 UI 优化


  - 为 VolumeCard 添加 Tailwind 样式
  - 实现分卷进度条动画
  - 优化拖放视觉反馈
  - 添加加载状态指示器
  - 确保响应式布局
  - _需求: 4.3, 4.4, 4.5_


- [x] 16. 错误处理和边界情况

  - 添加分卷操作的错误提示
  - 处理 AI 生成失败情况
  - 添加数据验证（标题长度、必需字段）
  - 实现操作确认对话框（删除分卷）
  - _需求: 1.4, 2.4, 3.5_


- [x] 17. 最终检查点 - 全部完成


  - 确保所有测试通过，询问用户是否满意

## 注意事项

- 每个任务完成后应运行相关测试确保没有破坏现有功能
- 优先实现核心功能，UI 优化可以后期迭代
- 保持与现有代码风格一致（TypeScript、React Hooks、Tailwind）
- 分卷通常包含 100-150 章，需要考虑大数据量的性能优化

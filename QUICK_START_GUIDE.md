# 🚀 Token 优化功能快速入门

## 📋 目录

1. [启用 Token 预算控制](#1-启用-token-预算控制)
2. [查看使用统计](#2-查看使用统计)
3. [启用 RAG 检索增强](#3-启用-rag-检索增强)
4. [测试优化效果](#4-测试优化效果)

---

## 1. 启用 Token 预算控制

### 步骤：

1. **打开应用设置**
   - 点击侧边栏底部的"设置"图标
   - 或使用快捷键（如果有）

2. **找到"高级设置"部分**
   - 向下滚动到"高级设置"卡片

3. **启用 Token 预算控制**
   - 点击"Token 预算控制"右侧的开关
   - 开关变为蓝色表示已启用

4. **配置预算参数**
   - **每日限制**：设置每天最多使用多少 tokens
     - 推荐值：100,000 tokens（约 $0.50/天）
     - 轻度使用：50,000 tokens
     - 重度使用：200,000 tokens
   
   - **警告阈值**：设置在达到多少百分比时开始警告
     - 推荐值：80%
     - 保守：70%
     - 激进：90%

5. **保存设置**
   - 点击页面底部的"保存设置"按钮

### 效果：

- ✅ 每次 AI 调用前会检查是否超出预算
- ✅ 达到警告阈值时会在控制台显示警告
- ✅ 超出限制时会弹窗询问是否继续
- ✅ 每天 00:00 自动重置使用量

---

## 2. 查看使用统计

### 位置：

应用设置页面顶部的"Token 使用统计"卡片

### 显示内容：

1. **今日使用**
   - 显示今天已使用的 token 数量
   - 带有趋势图标

2. **总输入**
   - 所有 AI 调用的输入 token 总和

3. **总输出**
   - 所有 AI 调用的输出 token 总和

4. **预估成本**
   - 根据模型定价计算的总成本（美元）
   - 显示总调用次数

5. **预算使用进度条**（如果启用了预算控制）
   - 绿色：正常使用
   - 黄色：接近警告阈值
   - 红色：超出限制

### 操作：

- **清除记录**：点击右上角的"清除记录"按钮
  - 会清除所有历史统计数据
  - 不影响今日使用量（今日数据会保留到明天）

---

## 3. 启用 RAG 检索增强

### 什么是 RAG？

RAG（Retrieval-Augmented Generation）是一种智能检索技术，可以：
- 根据语义相似度查找相关章节（而不是固定取最近几章）
- 只传递真正相关的角色信息
- 减少无关上下文，节省 token

### 支持的提供商：

✅ **Google Gemini**（推荐，使用 text-embedding-004）
✅ **OpenAI**（使用 text-embedding-3-small）
✅ **自定义提供商**（需要支持 OpenAI 兼容的 Embedding API）
❌ **DeepSeek**（暂不支持，官方未提供 Embedding API）

### 步骤：

1. **启用 RAG**
   - 在"高级设置"中找到"启用 RAG 检索增强"
   - 点击右侧开关启用

2. **索引现有内容**
   - 打开任意章节的编辑器
   - 点击右侧面板的"索引章节"按钮
   - 等待索引完成（首次可能需要几秒）
   - 对所有重要章节重复此操作

3. **自动索引**
   - 新生成的章节会自动索引
   - 无需手动操作

### 效果：

- ✅ 章节生成时会智能检索最相关的 3 章作为前情提要
- ✅ 如果角色数量 > 5，会智能检索最相关的 5 个角色
- ✅ Token 使用量减少约 20%
- ✅ 生成内容更连贯（因为上下文更相关）

### 降级策略：

如果 RAG 检索失败（网络问题、API 错误等），系统会自动回退到传统方式：
- 章节：取最近 3 章
- 角色：取前 5 个角色

---

## 4. 测试优化效果

### 测试 1：AI Chat Token 节省

**优化前的行为：**
- 进行 20 轮对话
- 每轮对话都会携带完整历史
- Token 消耗线性增长

**优化后的行为：**
- 只保留最近 10 轮对话
- 早期对话会被自动摘要
- Token 消耗保持稳定

**测试步骤：**

1. 打开 AI Chat 功能
2. 与 AI 进行 20 轮对话（随便聊什么）
3. 打开应用设置查看统计
4. 观察"今日使用"数量

**预期结果：**
- 20 轮对话约消耗 3,000-5,000 tokens
- 如果没有优化，会消耗 10,000-15,000 tokens

---

### 测试 2：章节生成 RAG 效果

**前提：** 已启用 RAG 并索引了至少 10 章内容

**测试步骤：**

1. 创建一个新章节，摘要中提到某个特定角色或情节
2. 生成章节内容
3. 观察生成的内容是否引用了相关的早期章节
4. 打开浏览器控制台，查看是否有 RAG 检索日志

**预期结果：**
- 生成的内容会引用语义相关的章节（而不是最近的章节）
- 控制台会显示类似 "RAG retrieval succeeded" 的日志

---

### 测试 3：Token 预算警告

**测试步骤：**

1. 设置一个很低的每日限制（如 1,000 tokens）
2. 设置警告阈值为 50%
3. 尝试生成一章内容
4. 观察是否弹出预算警告

**预期结果：**
- 在生成前会弹出警告对话框
- 显示当前使用量、限制和预计使用量
- 可以选择继续或取消

---

## 🎯 最佳实践

### 1. 合理设置预算

根据使用频率设置每日限制：

| 使用场景 | 推荐限制 | 预估成本/天 |
|---------|---------|------------|
| 轻度使用（1-2 章/天） | 50,000 | $0.25 |
| 中度使用（3-5 章/天） | 100,000 | $0.50 |
| 重度使用（10+ 章/天） | 200,000 | $1.00 |
| 专业作者 | 500,000 | $2.50 |

### 2. 定期查看统计

- 每周查看一次使用统计
- 了解哪些操作消耗最多 token
- 根据实际使用调整预算

### 3. 合理使用 RAG

**适合启用 RAG 的场景：**
- ✅ 长篇小说（50+ 章）
- ✅ 复杂世界观（多个势力、地点）
- ✅ 大量角色（10+ 个）

**不适合启用 RAG 的场景：**
- ❌ 短篇小说（< 10 章）
- ❌ 简单故事线
- ❌ 使用非 Google 提供商

### 4. AI Chat 使用技巧

- 避免无意义的长对话
- 定期开始新对话（清除历史）
- 提问时尽量具体明确

---

## ❓ 常见问题

### Q1: Token 统计不准确怎么办？

**A:** Token 数量是估算的，误差在 ±10% 是正常的。如果需要精确统计，可以查看 AI 提供商的官方账单。

### Q2: RAG 检索失败怎么办？

**A:** 检查以下几点：
1. 是否使用 Google Gemini 提供商
2. API Key 是否有效
3. 网络连接是否正常
4. 内容是否已索引

如果仍然失败，系统会自动回退到传统方式，不影响使用。

### Q3: 预算警告太频繁怎么办？

**A:** 有两个解决方案：
1. 增加每日限制
2. 提高警告阈值（如从 80% 改为 90%）
3. 禁用预算控制

### Q4: 如何导出使用记录？

**A:** 目前可以通过浏览器控制台导出：

```javascript
// 打开浏览器控制台（F12）
// 输入以下代码
const records = JSON.parse(localStorage.getItem('inkflow_token_usage'));
console.log(records);

// 或导出为 JSON 文件
const dataStr = JSON.stringify(records, null, 2);
const dataBlob = new Blob([dataStr], {type: 'application/json'});
const url = URL.createObjectURL(dataBlob);
const link = document.createElement('a');
link.href = url;
link.download = 'token_usage.json';
link.click();
```

### Q5: 清除记录后能恢复吗？

**A:** 不能。清除记录是永久性的，建议在清除前先导出备份。

---

## 📞 获取帮助

如果遇到问题：

1. 查看浏览器控制台的错误信息
2. 检查 `OPTIMIZATION_SUMMARY.md` 中的故障排除部分
3. 提交 Issue 并附上：
   - 错误信息截图
   - 浏览器控制台日志
   - 使用的 AI 提供商和模型

---

## 🎉 享受优化后的体验！

现在你已经掌握了所有优化功能的使用方法。开始创作吧，让 AI 更高效地为你服务！

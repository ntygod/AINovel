# 📝 文本排版优化指南

## 🎯 优化目标

让 AI 生成的小说正文更符合人类阅读习惯，提升阅读体验。

---

## ✨ 已实现的优化

### 1. 优化的 AI Prompt

在 `services/geminiService.ts` 中，我们为 AI 提供了详细的排版要求：

#### 排版规则

1. **段落分明**：每个自然段之间空一行
2. **对话独立**：每句对话单独成段
3. **场景转换**：场景切换时空两行
4. **段落长度**：每段 2-4 句话，避免大段文字
5. **标点规范**：使用中文标点，对话用双引号

#### 示例对比

**✅ 优化后（正确格式）：**
```
林风站在山巅，俯瞰着脚下的云海。晨光初现，金色的阳光穿透云层，在他身上镀上一层淡淡的光晕。

"终于到了。"他轻声自语，眼中闪过一丝坚定。

这一路走来，历经千辛万苦，如今终于站在了这传说中的天元峰顶。


山脚下，一道身影正急速攀登。

"师兄，等等我！"少女的声音在山谷中回荡。
```

**❌ 优化前（错误格式）：**
```
林风站在山巅，俯瞰着脚下的云海。晨光初现，金色的阳光穿透云层，在他身上镀上一层淡淡的光晕。"终于到了。"他轻声自语，眼中闪过一丝坚定。这一路走来，历经千辛万苦，如今终于站在了这传说中的天元峰顶。山脚下，一道身影正急速攀登。"师兄，等等我！"少女的声音在山谷中回荡。
```

---

### 2. 智能文本格式化器

创建了 `services/textFormatter.ts`，提供多个格式化工具：

#### 核心功能

1. **`formatAIGeneratedText(text)`**
   - 将纯文本转换为格式良好的 HTML
   - 自动识别段落、对话、标题
   - 保留场景转换的空行

2. **`smartParagraphSplit(text)`**
   - 智能分段，将大段文字拆分
   - 每 2-3 句话成一段
   - 对话自动独立成段

3. **`cleanAIText(text)`**
   - 清理多余空格
   - 标准化标点符号
   - 统一引号格式

4. **`prepareContentForEditor(rawText)`**
   - 组合所有格式化步骤
   - 为编辑器准备最终内容

5. **`countWords(text)`**
   - 准确计算字数
   - 支持中英文混合

---

### 3. 编辑器集成

在 `components/Editor.tsx` 中：

- ✅ AI 生成完成后自动格式化
- ✅ 使用新的字数统计方法
- ✅ 保持实时预览流畅性

---

## 🎨 排版效果对比

### 段落处理

**优化前：**
- 整段文字没有分段
- 对话和叙述混在一起
- 难以快速浏览

**优化后：**
- 段落清晰分明
- 对话独立醒目
- 易于阅读和理解

### 对话处理

**优化前：**
```
他说"你好"然后转身离开了。
```

**优化后：**
```
"你好。"他说道。

然后转身离开了。
```

### 场景转换

**优化前：**
```
...结束了战斗。第二天，阳光明媚...
```

**优化后：**
```
...结束了战斗。


第二天，阳光明媚...
```

---

## 🔧 使用方法

### 自动应用（推荐）

生成内容时会自动格式化，无需手动操作。

### 手动格式化

如果需要手动格式化已有内容：

```typescript
import { prepareContentForEditor } from './services/textFormatter';

// 格式化文本
const formatted = prepareContentForEditor(rawText);
```

---

## 📊 格式化规则详解

### 1. 段落识别

**规则：**
- 空行分隔段落
- 每段 2-4 句话
- 对话独立成段

**示例：**
```
输入：
"你好。"他说。然后离开了。

输出：
<p>"你好。"他说。</p>
<p>然后离开了。</p>
```

### 2. 对话识别

**识别条件：**
- 以引号开头：`"` `「` `『`
- 包含对话引号

**处理方式：**
- 独立成段
- 添加 `dialogue` 类名（可用于样式）

### 3. 标题识别

**识别条件：**
- 长度 < 30 字符
- 以"第X章"开头
- 没有句末标点

**处理方式：**
- 转换为 `<h2>` 标签

### 4. 场景转换

**识别条件：**
- 连续 3+ 个空行

**处理方式：**
- 保留 2 个空行
- 视觉上形成明显分隔

---

## 🎯 最佳实践

### 1. 编写章节摘要时

**好的摘要：**
```
主角林风在山巅遇到神秘老者，获得传承。
随后遭遇敌对势力追杀，展开激烈战斗。
最终突破境界，击退敌人。
```

**不好的摘要：**
```
主角遇到一些事情，然后发生了一些变化。
```

### 2. 编写细纲时

**好的细纲：**
```
1. 林风登上山巅，描写壮丽景色
2. 神秘老者出现，传授功法
3. 敌人突袭，激烈战斗
4. 林风突破，反败为胜
5. 老者离去，留下谜团
```

**不好的细纲：**
```
1. 开始
2. 中间
3. 结束
```

### 3. 生成后检查

生成完成后，建议检查：
- [ ] 段落是否清晰
- [ ] 对话是否独立
- [ ] 场景转换是否明显
- [ ] 标点是否规范

---

## 🔍 故障排查

### 问题 1：段落没有分开

**可能原因：**
- AI 生成的文本没有空行
- 格式化器未正确识别

**解决方法：**
1. 手动添加空行
2. 使用编辑器的"格式化"功能（如果有）
3. 重新生成内容

### 问题 2：对话没有独立

**可能原因：**
- 引号格式不标准
- 对话和叙述紧密连接

**解决方法：**
1. 检查引号是否正确
2. 手动调整段落
3. 在 prompt 中强调对话格式

### 问题 3：格式化后内容丢失

**可能原因：**
- 特殊字符处理问题
- HTML 转义问题

**解决方法：**
1. 检查浏览器控制台错误
2. 查看原始内容是否完整
3. 尝试重新生成

---

## 🚀 未来改进方向

### 短期

- [ ] 添加更多排版样式选项
- [ ] 支持自定义段落长度
- [ ] 添加"重新格式化"按钮

### 中期

- [ ] 智能识别更多文本模式
- [ ] 支持不同文体的排版规则
- [ ] 添加排版预览功能

### 长期

- [ ] AI 学习用户的排版偏好
- [ ] 自动优化段落节奏
- [ ] 支持导出时的排版定制

---

## 📚 相关文件

- `services/geminiService.ts` - AI Prompt 优化
- `services/textFormatter.ts` - 文本格式化工具
- `components/Editor.tsx` - 编辑器集成
- `components/RichEditor.tsx` - 富文本编辑器

---

## 💡 提示

1. **生成前准备**：详细的摘要和细纲能帮助 AI 生成更好的排版
2. **及时调整**：生成后可以手动微调排版
3. **保存快照**：重要修改前记得保存快照
4. **反馈改进**：如果发现排版问题，可以调整 prompt

---

## 🎉 总结

通过优化 AI Prompt 和添加智能格式化工具，现在生成的小说正文：

- ✅ 段落清晰分明
- ✅ 对话独立醒目
- ✅ 场景转换明显
- ✅ 易于阅读理解
- ✅ 符合网文排版习惯

享受更好的创作体验！✨

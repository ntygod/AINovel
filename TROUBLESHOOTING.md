# ğŸ”§ æ•…éšœæ’æŸ¥æŒ‡å—

## é—®é¢˜ï¼šç‚¹å‡»"AI ç”Ÿæˆç»†çº²"æ²¡æœ‰ååº”

### âœ… å·²ä¿®å¤

**é—®é¢˜åŸå› ï¼š**
- `generateChapterBeats` å‡½æ•°åªæ”¯æŒ Google Gemini æä¾›å•†
- ä½¿ç”¨å…¶ä»–æä¾›å•†ï¼ˆDeepSeekã€OpenAIã€Customï¼‰æ—¶ä¼šè¿”å›ç©ºæ•°ç»„
- æ²¡æœ‰é”™è¯¯æç¤ºï¼Œå¯¼è‡´ç”¨æˆ·ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ

**ä¿®å¤å†…å®¹ï¼š**
1. âœ… æ·»åŠ äº†å¯¹æ‰€æœ‰æä¾›å•†çš„æ”¯æŒ
2. âœ… æ·»åŠ äº† Token é¢„ç®—æ£€æŸ¥
3. âœ… æ·»åŠ äº†ä½¿ç”¨è®°å½•
4. âœ… æ”¹è¿›äº†é”™è¯¯å¤„ç†

**ç°åœ¨æ”¯æŒï¼š**
- âœ… Google Gemini
- âœ… DeepSeek
- âœ… OpenAI
- âœ… è‡ªå®šä¹‰æä¾›å•†

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### 1. æŒ‰é’®ç‚¹å‡»æ— ååº”

**å¯èƒ½åŸå› ï¼š**
- [ ] æœªé…ç½® API Key
- [ ] ç« èŠ‚ä¿¡æ¯ä¸å®Œæ•´
- [ ] Token é¢„ç®—å·²ç”¨å®Œ
- [ ] ç½‘ç»œè¿æ¥é—®é¢˜
- [ ] API è°ƒç”¨å¤±è´¥

**æ’æŸ¥æ­¥éª¤ï¼š**

1. **æ£€æŸ¥ API Key**
   ```
   åº”ç”¨è®¾ç½® â†’ AI æ¨¡å‹æœåŠ¡å•† â†’ æ£€æŸ¥ API Key æ˜¯å¦å·²å¡«å†™
   ```

2. **æ£€æŸ¥ç« èŠ‚ä¿¡æ¯**
   - ç« èŠ‚æ ‡é¢˜æ˜¯å¦å·²å¡«å†™
   - ç« èŠ‚æ‘˜è¦æ˜¯å¦å·²å¡«å†™

3. **æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°**
   - æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
   - åˆ‡æ¢åˆ° Console æ ‡ç­¾
   - æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

4. **æ£€æŸ¥ Token é¢„ç®—**
   ```
   åº”ç”¨è®¾ç½® â†’ Token ä½¿ç”¨ç»Ÿè®¡ â†’ æŸ¥çœ‹ä»Šæ—¥ä½¿ç”¨é‡
   ```

5. **æµ‹è¯•ç½‘ç»œè¿æ¥**
   - å°è¯•ç”Ÿæˆå…¶ä»–å†…å®¹ï¼ˆå¦‚ç« èŠ‚å†…å®¹ï¼‰
   - æ£€æŸ¥æ˜¯å¦èƒ½è®¿é—® AI æä¾›å•†çš„ API

---

### 2. ç”Ÿæˆçš„ç»†çº²è´¨é‡ä¸å¥½

**å¯èƒ½åŸå› ï¼š**
- ç« èŠ‚æ‘˜è¦å†™å¾—å¤ªç®€å•
- ç¼ºå°‘ä¸Šä¸‹æ–‡ä¿¡æ¯
- æ¨¡å‹é€‰æ‹©ä¸å½“

**è§£å†³æ–¹æ³•ï¼š**

1. **ä¼˜åŒ–ç« èŠ‚æ‘˜è¦**
   - å†™å¾—æ›´è¯¦ç»†å…·ä½“
   - åŒ…å«å…³é”®æƒ…èŠ‚ç‚¹
   - æåŠé‡è¦è§’è‰²

2. **å®Œå–„é¡¹ç›®è®¾ç½®**
   - å¡«å†™è¯¦ç»†çš„ä¸–ç•Œè®¾å®š
   - æ·»åŠ ä¸»è¦è§’è‰²
   - è®¾ç½®æ˜ç¡®çš„ä¸»çº¿å‰§æƒ…

3. **é€‰æ‹©æ›´å¥½çš„æ¨¡å‹**
   - Google: `gemini-2.0-flash-exp` æˆ– `gemini-1.5-pro`
   - OpenAI: `gpt-4o`
   - DeepSeek: `deepseek-chat`

---

### 3. ç”Ÿæˆé€Ÿåº¦å¾ˆæ…¢

**å¯èƒ½åŸå› ï¼š**
- ç½‘ç»œå»¶è¿Ÿ
- API æœåŠ¡å™¨è´Ÿè½½é«˜
- æ¨¡å‹å“åº”æ…¢

**è§£å†³æ–¹æ³•ï¼š**

1. **æ£€æŸ¥ç½‘ç»œ**
   - ä½¿ç”¨ç½‘ç»œæµ‹é€Ÿå·¥å…·
   - å°è¯•åˆ‡æ¢ç½‘ç»œ

2. **æ›´æ¢æ¨¡å‹**
   - ä½¿ç”¨ Flash ç³»åˆ—æ¨¡å‹ï¼ˆæ›´å¿«ï¼‰
   - Google: `gemini-2.0-flash-exp`
   - OpenAI: `gpt-4o-mini`

3. **ä½¿ç”¨æœ¬åœ°æ¨¡å‹**
   - å®‰è£… Ollama
   - ä½¿ç”¨æœ¬åœ° LLM

---

### 4. æç¤º "Token budget exceeded"

**åŸå› ï¼š** è¶…å‡ºæ¯æ—¥ Token é™åˆ¶

**è§£å†³æ–¹æ³•ï¼š**

1. **ç­‰å¾…é‡ç½®**
   - Token é¢„ç®—æ¯å¤© 00:00 é‡ç½®

2. **å¢åŠ é™åˆ¶**
   ```
   åº”ç”¨è®¾ç½® â†’ é«˜çº§è®¾ç½® â†’ Token é¢„ç®—æ§åˆ¶ â†’ å¢åŠ æ¯æ—¥é™åˆ¶
   ```

3. **ä¸´æ—¶ç¦ç”¨é¢„ç®—**
   ```
   åº”ç”¨è®¾ç½® â†’ é«˜çº§è®¾ç½® â†’ Token é¢„ç®—æ§åˆ¶ â†’ å…³é—­å¼€å…³
   ```

---

### 5. API è°ƒç”¨å¤±è´¥

**é”™è¯¯ç¤ºä¾‹ï¼š**
```
Error: OpenAI/DeepSeek API Error: 401 Unauthorized
Error: Failed to generate beats
```

**æ’æŸ¥æ­¥éª¤ï¼š**

1. **æ£€æŸ¥ API Key**
   - ç¡®è®¤ Key å¤åˆ¶å®Œæ•´
   - ç¡®è®¤ Key æœªè¿‡æœŸ
   - ç¡®è®¤ Key æœ‰ç›¸åº”æƒé™

2. **æ£€æŸ¥ Base URL**
   - Google: ç•™ç©ºæˆ–ä½¿ç”¨ä»£ç†åœ°å€
   - DeepSeek: `https://api.deepseek.com`
   - OpenAI: `https://api.openai.com/v1`
   - Ollama: `http://localhost:11434/v1`

3. **æ£€æŸ¥è´¦æˆ·ä½™é¢**
   - OpenAI: æŸ¥çœ‹è´¦æˆ·ä½™é¢
   - DeepSeek: æŸ¥çœ‹è´¦æˆ·ä½™é¢

4. **æµ‹è¯• API è¿æ¥**
   ```bash
   # Google Gemini
   curl https://generativelanguage.googleapis.com/v1beta/models \
     -H "x-goog-api-key: YOUR_API_KEY"
   
   # OpenAI
   curl https://api.openai.com/v1/models \
     -H "Authorization: Bearer YOUR_API_KEY"
   
   # DeepSeek
   curl https://api.deepseek.com/v1/models \
     -H "Authorization: Bearer YOUR_API_KEY"
   ```

---

### 6. ä¸­å›½å¤§é™†è®¿é—®é—®é¢˜

**ç—‡çŠ¶ï¼š**
- è¯·æ±‚è¶…æ—¶
- è¿æ¥å¤±è´¥
- 403 Forbidden

**è§£å†³æ–¹æ³•ï¼š**

1. **ä½¿ç”¨ä»£ç†**
   ```typescript
   // åœ¨åº”ç”¨è®¾ç½®ä¸­é…ç½®
   {
     provider: 'google',
     apiKey: 'YOUR_KEY',
     baseUrl: 'https://your-proxy.com/v1beta'
   }
   ```

2. **ä½¿ç”¨å›½å†…å¯ç”¨çš„æä¾›å•†**
   - DeepSeekï¼ˆå›½å†…å¯ç›´æ¥è®¿é—®ï¼‰
   - é˜¿é‡Œäº‘é€šä¹‰åƒé—®
   - ç™¾åº¦æ–‡å¿ƒä¸€è¨€

3. **ä½¿ç”¨æœ¬åœ°æ¨¡å‹**
   - Ollama + Llama 3
   - å®Œå…¨æœ¬åœ°è¿è¡Œï¼Œæ— éœ€ç½‘ç»œ

---

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

**æµè§ˆå™¨æ§åˆ¶å°ï¼š**
```javascript
// æŸ¥çœ‹ Token ä½¿ç”¨æƒ…å†µ
import { tokenCounter } from './services/tokenCounter';
console.log(tokenCounter.getStats());

// æŸ¥çœ‹å‘é‡æ•°æ®
const request = indexedDB.open('InkFlowDB', 5);
request.onsuccess = () => {
    const db = request.result;
    const tx = db.transaction(['vectors'], 'readonly');
    const store = tx.objectStore('vectors');
    const req = store.getAll();
    req.onsuccess = () => console.log('Vectors:', req.result);
};
```

### 2. æµ‹è¯• API è°ƒç”¨

**åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š**
```javascript
// æµ‹è¯•ç»†çº²ç”Ÿæˆ
const testBeats = async () => {
    const { generateChapterBeats } = await import('./services/geminiService');
    const chapter = {
        id: 'test',
        title: 'æµ‹è¯•ç« èŠ‚',
        summary: 'ä¸»è§’é‡åˆ°äº†å¼ºå¤§çš„æ•Œäºº',
        order: 1,
        content: '',
        wordCount: 0
    };
    const config = {
        title: 'æµ‹è¯•å°è¯´',
        genre: 'ç„å¹»',
        // ... å…¶ä»–é…ç½®
    };
    const settings = {
        provider: 'google',
        apiKey: 'YOUR_KEY',
        model: 'gemini-2.0-flash-exp'
    };
    
    try {
        const beats = await generateChapterBeats(chapter, [], config, [], settings);
        console.log('ç”Ÿæˆçš„ç»†çº²:', beats);
    } catch (e) {
        console.error('é”™è¯¯:', e);
    }
};

testBeats();
```

### 3. æ¸…é™¤ç¼“å­˜

**å¦‚æœé‡åˆ°å¥‡æ€ªçš„é—®é¢˜ï¼š**

1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
   - Chrome: Ctrl+Shift+Delete
   - é€‰æ‹©"ç¼“å­˜çš„å›¾ç‰‡å’Œæ–‡ä»¶"
   - ç‚¹å‡»"æ¸…é™¤æ•°æ®"

2. **æ¸…é™¤ IndexedDB**
   ```javascript
   // åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
   indexedDB.deleteDatabase('InkFlowDB');
   location.reload();
   ```

3. **é‡å¯å¼€å‘æœåŠ¡å™¨**
   ```bash
   # åœæ­¢æœåŠ¡å™¨ï¼ˆCtrl+Cï¼‰
   # é‡æ–°å¯åŠ¨
   npm run dev
   ```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å‡å°‘ API è°ƒç”¨

- å…ˆæ‰‹åŠ¨ç¼–å†™ç»†çº²ï¼Œå†è®© AI ä¼˜åŒ–
- æ‰¹é‡ç”Ÿæˆå¤šä¸ªç« èŠ‚çš„ç»†çº²
- å¤ç”¨ç›¸ä¼¼ç« èŠ‚çš„ç»†çº²

### 2. ä½¿ç”¨ç¼“å­˜

- ç›¸åŒçš„ç« èŠ‚æ‘˜è¦ä¼šç”Ÿæˆç›¸ä¼¼çš„ç»†çº²
- å¯ä»¥ä¿å­˜å¸¸ç”¨çš„ç»†çº²æ¨¡æ¿

### 3. é€‰æ‹©åˆé€‚çš„æ¨¡å‹

| åœºæ™¯ | æ¨èæ¨¡å‹ | åŸå›  |
|------|---------|------|
| å¿«é€Ÿè‰ç¨¿ | gemini-2.0-flash-exp | é€Ÿåº¦å¿«ï¼Œå…è´¹ |
| é«˜è´¨é‡ | gemini-1.5-pro | è´¨é‡å¥½ |
| æˆæœ¬ä¼˜å…ˆ | deepseek-chat | ä¾¿å®œ |
| éšç§ä¼˜å…ˆ | Ollama (æœ¬åœ°) | å®Œå…¨æœ¬åœ° |

---

## è·å–å¸®åŠ©

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼š

1. **æŸ¥çœ‹å®Œæ•´é”™è¯¯ä¿¡æ¯**
   - æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
   - å¤åˆ¶å®Œæ•´çš„é”™è¯¯å †æ ˆ

2. **æä¾›ç¯å¢ƒä¿¡æ¯**
   - æ“ä½œç³»ç»Ÿ
   - æµè§ˆå™¨ç‰ˆæœ¬
   - AI æä¾›å•†å’Œæ¨¡å‹
   - æ˜¯å¦å¯ç”¨äº† RAG/Token é¢„ç®—

3. **æäº¤ Issue**
   - é™„ä¸Šé”™è¯¯æˆªå›¾
   - é™„ä¸Šæ§åˆ¶å°æ—¥å¿—
   - æè¿°å¤ç°æ­¥éª¤

---

## æ›´æ–°æ—¥å¿—

### 2024-01-XX - ç»†çº²ç”Ÿæˆä¿®å¤

- âœ… ä¿®å¤äº†é Google æä¾›å•†æ— æ³•ç”Ÿæˆç»†çº²çš„é—®é¢˜
- âœ… æ·»åŠ äº† Token é¢„ç®—æ£€æŸ¥
- âœ… æ”¹è¿›äº†é”™è¯¯å¤„ç†
- âœ… æ·»åŠ äº†ä½¿ç”¨è®°å½•

---

**æç¤ºï¼š** å¤§éƒ¨åˆ†é—®é¢˜éƒ½å¯ä»¥é€šè¿‡æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯æ¥å®šä½ã€‚é‡åˆ°é—®é¢˜æ—¶ï¼Œç¬¬ä¸€æ­¥æ°¸è¿œæ˜¯æ‰“å¼€ F12 æŸ¥çœ‹ Consoleï¼


---

## ğŸ†• æœ€æ–°ä¿®å¤

### é—®é¢˜ï¼šç”Ÿæˆç»†çº²åé¡µé¢ç©ºç™½ï¼ˆchapter.beats.map is not a functionï¼‰

**é”™è¯¯ä¿¡æ¯ï¼š**
```
Uncaught TypeError: chapter.beats.map is not a function
at Editor (Editor.tsx:513:66)
```

**åŸå› ï¼š**
- AI è¿”å›çš„ç»†çº²æ•°æ®æ ¼å¼ä¸æ­£ç¡®
- `chapter.beats` ä¸æ˜¯æ•°ç»„ç±»å‹
- å¯èƒ½æ˜¯ API è¿”å›äº†é”™è¯¯æ ¼å¼çš„æ•°æ®

**å·²ä¿®å¤ï¼š**
1. âœ… æ·»åŠ äº†æ•°ç»„ç±»å‹æ£€æŸ¥
2. âœ… æ·»åŠ äº†é”™è¯¯æç¤º
3. âœ… æ·»åŠ äº†é™çº§å¤„ç†
4. âœ… æ”¹è¿›äº†é”™è¯¯å¤„ç†

**å¦‚æœä»ç„¶é‡åˆ°é—®é¢˜ï¼š**

1. **åˆ·æ–°é¡µé¢**ï¼ˆCtrl+R æˆ– F5ï¼‰
2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
3. **æ£€æŸ¥ API è¿”å›æ•°æ®**
   ```javascript
   // åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹
   console.log('Beats data:', chapter.beats);
   console.log('Is array:', Array.isArray(chapter.beats));
   ```

4. **é‡æ–°ç”Ÿæˆç»†çº²**
   - ç¡®ä¿ç« èŠ‚æ‘˜è¦å®Œæ•´
   - ç¡®ä¿ API Key æœ‰æ•ˆ
   - å°è¯•ä¸åŒçš„ AI æ¨¡å‹

---

## ğŸ“Š æ•°æ®æ ¼å¼è¯´æ˜

### æ­£ç¡®çš„ç»†çº²æ ¼å¼

```typescript
chapter.beats = [
  "ä¸»è§’ç™»åœºï¼Œå±•ç¤ºå®åŠ›",
  "é‡åˆ°å¼ºæ•Œï¼Œé™·å…¥å›°å¢ƒ",
  "çªç ´å¢ƒç•Œï¼Œåè´¥ä¸ºèƒœ",
  "è·å¾—å®ç‰©ï¼Œå®åŠ›æå‡",
  "åŸ‹ä¸‹ä¼ç¬”ï¼Œå¼•å‡ºä¸‹ç« "
]
```

### é”™è¯¯çš„æ ¼å¼ï¼ˆä¼šå¯¼è‡´å´©æºƒï¼‰

```typescript
// ä¸æ˜¯æ•°ç»„
chapter.beats = "ä¸»è§’ç™»åœºï¼Œå±•ç¤ºå®åŠ›"

// å¯¹è±¡æ ¼å¼
chapter.beats = { 0: "ä¸»è§’ç™»åœº", 1: "é‡åˆ°å¼ºæ•Œ" }

// null æˆ– undefined
chapter.beats = null
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹ç»†çº²æ•°æ®

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// è·å–å½“å‰ç« èŠ‚æ•°æ®
const getCurrentChapter = () => {
  // ä» React DevTools æˆ–å…¨å±€çŠ¶æ€è·å–
  return window.__REACT_DEVTOOLS_GLOBAL_HOOK__.renderers.get(1)
    .getCurrentFiber().memoizedState.memoizedState;
};

// æŸ¥çœ‹ç»†çº²
console.log('Beats:', getCurrentChapter().beats);
```

### æ‰‹åŠ¨ä¿®å¤æ•°æ®

å¦‚æœæ•°æ®æ ¼å¼é”™è¯¯ï¼Œå¯ä»¥æ‰‹åŠ¨ä¿®å¤ï¼š

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
const fixBeats = () => {
  const db = indexedDB.open('InkFlowDB', 5);
  db.onsuccess = () => {
    const transaction = db.result.transaction(['projects'], 'readwrite');
    const store = transaction.objectStore('projects');
    const request = store.getAll();
    
    request.onsuccess = () => {
      const projects = request.result;
      projects.forEach(project => {
        project.chapters.forEach(chapter => {
          // ç¡®ä¿ beats æ˜¯æ•°ç»„
          if (chapter.beats && !Array.isArray(chapter.beats)) {
            chapter.beats = [];
          }
        });
        store.put(project, project.id);
      });
      console.log('æ•°æ®å·²ä¿®å¤');
    };
  };
};

fixBeats();
```

---

## âœ… éªŒè¯ä¿®å¤

ä¿®å¤åï¼Œåº”è¯¥èƒ½å¤Ÿï¼š
- âœ… æ­£å¸¸ç”Ÿæˆç»†çº²
- âœ… æŸ¥çœ‹å’Œç¼–è¾‘ç»†çº²
- âœ… æ·»åŠ å’Œåˆ é™¤ç»†çº²é¡¹
- âœ… é¡µé¢ä¸ä¼šå´©æºƒ

å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„å®Œæ•´é”™è¯¯ä¿¡æ¯ã€‚
